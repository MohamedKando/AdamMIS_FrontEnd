<div class="content-header">
    <h2>DMS Report Management</h2>
    <div class="breadcrumb">
        <a href="#" routerLink="/dashboard">Home</a> > 
        <a href="#" routerLink="/dms-report">DMS Report</a> > 
        Report Management
    </div>
</div>

<div class="tabs-container">
    <div class="tabs-header">
        <button class="tab-button" 
                [class.active]="activeTab === 'user-reports'" 
                (click)="setActiveTab('user-reports')">
            <i class="icon">üë•</i>
            Report Manager
        </button>

        <button class="tab-button" 
                [class.active]="activeTab === 'reports'" 
                (click)="setActiveTab('reports')">
            <i class="icon">üìÑ</i>
            Add New Report
        </button>
        
        <button class="tab-button" 
                [class.active]="activeTab === 'categories'" 
                (click)="setActiveTab('categories')">
            <i class="icon">üìÅ</i>
            Add New Category
        </button>
    </div>

    <div class="tab-content">
        <!-- Report Categories Tab -->
        <div class="tab-pane" [class.active]="activeTab === 'categories'">
    <div class="grid-container">
        <!-- Add New Category Card -->
        <div class="card add-category-card">
            <h3>Add New Category</h3>
            <form (ngSubmit)="addCategory()" #categoryForm="ngForm">
                <div class="form-group">
                    <label for="categoryName">Category Name</label>
                    <input type="text" 
                           id="categoryName" 
                           [(ngModel)]="newCategory.name" 
                           name="categoryName" 
                           required 
                           placeholder="Enter category name">
                </div>
                <div class="form-group">
                    <label for="categoryDescription">Description</label>
                    <textarea id="categoryDescription" 
                              [(ngModel)]="newCategory.description" 
                              name="categoryDescription" 
                              placeholder="Enter category description"></textarea>
                </div>
                <div class="form-group">
                    <label for="categoryColor">Color</label>
                    <input type="color" 
                           id="categoryColor" 
                           [(ngModel)]="newCategory.color" 
                           name="categoryColor">
                </div>
                <button type="submit" 
                        class="btn btn-primary" 
                        [disabled]="!categoryForm.valid || isAddingCategory">
                    <span *ngIf="!isAddingCategory">Add Category</span>
                    <span *ngIf="isAddingCategory">Adding...</span>
                </button>
            </form>
        </div>

        <!-- Categories Search and Display Section -->
        <div class="card categories-library">
            <div class="library-header">
                <h3>Categories Library</h3>
                <div class="category-search-container">
                    <input type="text" 
                           [(ngModel)]="categorySearchTerm" 
                           (input)="filterCategories()" 
                           placeholder="Search categories by name or description..."
                           class="search-input">
                    <i class="search-icon">üîç</i>
                </div>
            </div>
            
            <!-- Categories Grid -->
            <div class="scrollable-content">
                <div class="categories-grid">
                    <div class="category-item" *ngFor="let category of filteredCategories">
                        <div class="category-color" [style.background-color]="category.color"></div>
                        <div class="category-details">
                            <h4>{{category.name}}</h4>
                            <p>{{category.description || 'No description'}}</p>
                            <span class="report-count">{{getReportCountForCategory(category.id)}} reports</span>
                        </div>
                        <div class="category-actions">
                            <button class="btn btn-sm btn-secondary" (click)="editCategory(category)">
                                <i class="icon">‚úèÔ∏è</i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger" (click)="initiateDeleteCategory(category.id)">
                                <i class="icon">üóëÔ∏è</i> Delete
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- No Results Message -->
                <div class="no-results" *ngIf="filteredCategories.length === 0 && categorySearchTerm">
                    <p>No categories found matching "{{categorySearchTerm}}"</p>
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- Reports Tab -->
        <div class="tab-pane" [class.active]="activeTab === 'reports'">
            <div class="grid-container">
                <!-- Upload Report Card -->
                <div class="card upload-card">
                    <h3>Upload New Report</h3>
                    <div class="upload-area" 
                         (dragover)="onDragOver($event)" 
                         (dragleave)="onDragLeave($event)" 
                         (drop)="onDrop($event)">
                        <p>üìÅ Drag and drop your .rpt file here or click to browse</p>
                        <input type="file" 
                               #fileInput 
                               class="file-input" 
                               accept=".rpt" 
                               (change)="onFileSelected($event)" 
                               [disabled]="isGenerating">
                        <button class="upload-btn" 
                                (click)="fileInput.click()" 
                                [disabled]="isGenerating">
                            Choose File
                        </button>
                    </div>
                    
                    <div class="file-info" *ngIf="fileName">
                        <p><strong>Selected file:</strong> <span>{{fileName}}</span></p>
                        <div class="form-group">
                            <label for="reportCategory">Select Category</label>
                            <select id="reportCategory" 
                                    [(ngModel)]="selectedCategoryId" 
                                    required>
                                <option value="">Select a category</option>
                                <option *ngFor="let category of categories" [value]="category.id">
                                    {{category.name}}
                                </option>
                            </select>
                        </div>
                        <button class="btn btn-primary" 
                                (click)="uploadReport()" 
                                [disabled]="isGenerating || !selectedCategoryId">
                            <span *ngIf="!isGenerating">Upload Report</span>
                            <span *ngIf="isGenerating">üîÑ Uploading...</span>
                        </button>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="progress-container" *ngIf="isGenerating">
                        <div class="progress-bar">
                            <div class="progress-fill" [style.width.%]="progress"></div>
                        </div>
                        <p class="progress-text">{{progress}}%</p>
                    </div>
                </div>

                <!-- Reports Library -->
                <div class="card reports-library">
                    <div class="library-header">
                        <h3>Reports Library</h3>
                       <div class="filters">
    <select [(ngModel)]="selectedFilterCategory" (change)="filterReports()">
        <option value="">All Categories</option>
        <option *ngFor="let category of categories" [value]="category.id">
            {{category.name}}
        </option>
    </select>
    <input type="text" 
           [(ngModel)]="searchTerm" 
           (input)="filterReports()" 
           placeholder="Search reports by name, category, or description...">
</div>
                    </div>
                    
                    <div class="scrollable-content">
                        <div class="reports-grid">
                            <div class="report-item" *ngFor="let report of filteredReports">
                                <div class="report-icon">üìÑ</div>
                                <div class="report-info">
                                    <h4>{{report.fileName}}</h4>
                                    <p>Category: {{report.categoryName}}</p>
                                    <p>Uploaded: {{report.createdAt | date:'short'}}</p>
                                    <p>By: {{report.createdBy}}</p>
                                </div>
                                <div class="report-actions">
                                    <button class="btn btn-sm btn-primary" (click)="viewReport(report)">
                                        <i class="icon">üëÅÔ∏è</i> View
                                    </button>
                                    <button class="btn btn-sm btn-danger" (click)="initiateDeleteReport(report.id)">
                                        <i class="icon">üóëÔ∏è</i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Manager Tab - Enhanced with proper nesting -->
        <div class="tab-pane" [class.active]="activeTab === 'user-reports'">
            <div class="report-manager-content">
                <!-- Section Title to show this is nested under Report Manager -->
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="icon">üë•</i>
                        Report Manager Options
                    </h3>
                    <p class="section-description">Manage user assignments and view reports overview</p>
                </div>

                <!-- Sub-tabs Navigation with enhanced styling -->
                <div class="sub-tabs-container">
                    <div class="sub-tabs-header">
                        <button class="sub-tab-button" 
                                [class.active]="activeUserReportsSubTab === 'assign'" 
                                (click)="setActiveUserReportsSubTab('assign')">
                            <i class="icon">‚ûï</i>
                            <span>Assign Reports</span>
                        </button>
                        <button class="sub-tab-button" 
                                [class.active]="activeUserReportsSubTab === 'overview'" 
                                (click)="setActiveUserReportsSubTab('overview')">
                            <i class="icon">üë•</i>
                            <span>User Overview</span>
                        </button>
                        <button class="sub-tab-button" 
                                [class.active]="activeUserReportsSubTab === 'history'" 
                                (click)="setActiveUserReportsSubTab('history')">
                            <i class="icon">üìã</i>
                            <span>Assignment History</span>
                        </button>
                    </div>

                    <div class="sub-tab-content">
                        <!-- Assign Reports Sub-tab -->
                        <div class="sub-tab-pane" [class.active]="activeUserReportsSubTab === 'assign'">
                            <div class="assign-reports-container">
                                <div class="card assign-reports-card">
                                    <div class="card-header">
                                        <h3>Assign Reports to Users</h3>
                                        <p class="card-subtitle">Select users and reports to create new assignments</p>
                                    </div>
                                    
                                    <div class="assignment-form">
                                        <!-- Assignment Mode Selection -->
                                        <div class="assignment-mode-selection">
                                            <div class="mode-toggle">
                                                <label>
                                                    <input type="radio" 
                                                           name="assignmentMode" 
                                                           value="individual" 
                                                           [(ngModel)]="assignmentMode"
                                                           (change)="onAssignmentModeChange()">
                                                    Individual Mode
                                                </label>
                                                <label>
                                                    <input type="radio" 
                                                           name="assignmentMode" 
                                                           value="category" 
                                                           [(ngModel)]="assignmentMode"
                                                           (change)="onAssignmentModeChange()">
                                                    Category Mode
                                                </label>
                                            </div>
                                        </div>

                                        <div class="assignment-grid">
                                            <!-- User Selection Section -->
                                            <div class="assignment-section">
                                                <div class="section-header">
                                                    <h4>Select Users</h4>
                                                    <span class="selection-count">{{selectedUserIds.length}} selected</span>
                                                </div>
                                                
                                                <div class="search-input-container">
                                                    <input type="text" 
                                                        [(ngModel)]="userSearchTerm" 
                                                        (input)="filterUsersForAssignment()"
                                                        placeholder="Search users by name or email..."
                                                        class="search-input">
                                                    <i class="search-icon">üîç</i>
                                                </div>
                                                
                                                <div class="scrollable-list">
                                                    <div class="user-list">
                                                        <div *ngFor="let user of getDisplayedUsers()" class="user-item">
                                                            <input type="checkbox" 
                                                                [id]="'user-' + user.id"
                                                                [value]="user.id" 
                                                                (change)="onUserSelection($event, user.id)">
                                                            <label [for]="'user-' + user.id" class="user-label">
                                                                <div class="user-avatar">{{user.userName.charAt(0).toUpperCase()}}</div>
                                                                <div class="user-info">
                                                                    <span class="user-name">{{user.userName}}</span>
                                                                    <span class="user-email">{{user.email}}</span>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Report Selection Section - Individual Mode -->
                                            <div class="assignment-section" *ngIf="assignmentMode === 'individual'">
                                                <div class="section-header">
                                                    <h4>Select Reports</h4>
                                                    <span class="selection-count">{{selectedReportIds.length}} selected</span>
                                                </div>
                                                
<div class="search-input-container">
    <input type="text" 
        [(ngModel)]="reportSearchTerm" 
        (input)="filterReportsForAssignment()"
        placeholder="Search reports by name, category, or description..."
        class="search-input">
    <i class="search-icon">üîç</i>
</div>
                                                <div class="scrollable-list">
                                                    <div class="report-list">
                                                        <div *ngFor="let report of getDisplayedReportsForAssignment()" class="report-item">
                                                            <input type="checkbox" 
                                                                [id]="'report-' + report.id"
                                                                [value]="report.id" 
                                                                (change)="onReportSelection($event, report.id)">
                                                            <label [for]="'report-' + report.id" class="report-label">
                                                                <div class="report-icon">üìÑ</div>
                                                                <div class="report-info">
                                                                    <span class="report-name">{{report.fileName}}</span>
                                                                    <span class="report-category">{{report.categoryName}}</span>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Category Selection Section - Category Mode -->
                                            <div class="assignment-section" *ngIf="assignmentMode === 'category'">
                                                <div class="section-header">
                                                    <h4>Select Category</h4>
                                                    <span class="selection-count" *ngIf="selectedCategoryForAssignment">
                                                        {{getReportCountForCategory(selectedCategoryForAssignment)}} reports
                                                    </span>
                                                </div>
                                                
                                                <div class="category-selection">
                                                    <select [(ngModel)]="selectedCategoryForAssignment" 
                                                            (change)="onCategorySelectionChange()"
                                                            class="category-dropdown">
                                                        <option [value]="null">Select a category...</option>
                                                        <option *ngFor="let category of categories" [value]="category.id">
                                                            {{category.name}} ({{getReportCountForCategory(category.id)}} reports)
                                                        </option>
                                                    </select>
                                                </div>

                                                <!-- Preview of reports in selected category -->
                                                <div class="category-reports-preview" *ngIf="selectedCategoryForAssignment">
                                                    <h5>Reports in this category:</h5>
                                                    <div class="scrollable-list">
                                                        <div class="report-list">
                                                            <div *ngFor="let report of getDisplayedReportsForAssignment()" 
                                                                 class="report-item preview-item">
                                                                <div class="report-icon">üìÑ</div>
                                                                <div class="report-info">
                                                                    <span class="report-name">{{report.fileName}}</span>
                                                                    <span class="report-category">{{report.categoryName}}</span>
                                                                </div>
                                                                <div class="report-date">{{report.createdAt | date:'short'}}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Assignment Actions -->
                                        <div class="assignment-actions">
                                            <div class="assignment-summary">
                                                <p *ngIf="assignmentMode === 'individual'">
                                                    Ready to assign <strong>{{selectedReportIds.length}}</strong> reports to <strong>{{selectedUserIds.length}}</strong> users
                                                </p>
                                                <p *ngIf="assignmentMode === 'category' && selectedCategoryForAssignment">
                                                    Ready to assign <strong>{{getReportCountForCategory(selectedCategoryForAssignment)}}</strong> reports 
                                                    from category <strong>{{getCategoryName(selectedCategoryForAssignment)}}</strong> 
                                                    to <strong>{{selectedUserIds.length}}</strong> users
                                                </p>
                                                <p *ngIf="assignmentMode === 'category' && !selectedCategoryForAssignment">
                                                    Please select a category and users to proceed
                                                </p>
                                            </div>
                                            <div class="action-buttons">
                                                <button type="button" 
                                                        class="btn btn-secondary" 
                                                        (click)="resetAssignmentForm()">
                                                    Clear Selection
                                                </button>
                                                <button type="button" 
                                                        class="btn btn-primary" 
                                                        (click)="assignReports()"
                                                        [disabled]="!canAssignReports() || isAssigning">
                                                    <span *ngIf="!isAssigning">Assign Reports</span>
                                                    <span *ngIf="isAssigning">üîÑ Assigning...</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- User Overview Sub-tab -->
                        <div class="sub-tab-pane" [class.active]="activeUserReportsSubTab === 'overview'">
                            <div class="user-overview-container">
                                <div class="card user-overview-card">
                                    <div class="card-header">
                                        <h3>User Overview</h3>
                                        <p class="card-subtitle">View and manage user report assignments</p>
                                    </div>
                                    
                                    <div class="overview-controls">
                                        <div class="search-input-container">
                                            <input type="text" 
                                                [(ngModel)]="userOverviewSearchTerm" 
                                                (input)="filterUsersWithReports()"
                                                placeholder="Search users..."
                                                class="search-input">
                                            <i class="search-icon">üîç</i>
                                        </div>
                                        
                                        <div class="overview-stats">
                                            <div class="stat-item">
                                                <span class="stat-number">{{usersWithReports.length}}</span>
                                                <span class="stat-label">Total Users</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-number">{{getTotalAssignments()}}</span>
                                                <span class="stat-label">Total Assignments</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="users-grid">
                                        <div class="user-card" *ngFor="let user of filteredUsersWithReports">
                                            <div class="user-header">
                                                <div class="user-avatar-large">{{user.userName.charAt(0).toUpperCase()}}</div>
                                                <div class="user-details">
                                                    <h4>{{user.userName}}</h4>
                                                    <p class="report-count">{{user.reportCount}} reports assigned</p>
                                                </div>
                                            </div>
                                            
                                            <div class="user-actions">
                                                <button class="btn btn-sm btn-primary" (click)="viewUserReports(user.id)">
                                                    <i class="icon">üëÅÔ∏è</i> View Reports
                                                </button>
                                                <button class="btn btn-sm btn-secondary" (click)="assignMoreReports(user.id)">
                                                    <i class="icon">‚ûï</i> Assign More
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Assignment History Sub-tab -->
                        <div class="sub-tab-pane" [class.active]="activeUserReportsSubTab === 'history'">
                            <div class="assignment-history-container">
                                <div class="card assignment-history-card">
                                    <div class="card-header">
                                        <h3>Assignment History</h3>
                                        <p class="card-subtitle">View and manage all report assignments</p>
                                    </div>
                                    
                                    <div class="history-controls">
                                        <div class="search-input-container">
                                            <input type="text" 
                                                [(ngModel)]="assignmentSearchTerm" 
                                                (input)="filterUserReportAssignments()"
                                                placeholder="Search assignments..."
                                                class="search-input">
                                            <i class="search-icon">üîç</i>
                                        </div>
                                        
                                        <div class="history-filters">
                                            <select [(ngModel)]="assignmentCategoryFilter" (change)="filterUserReportAssignments()">
                                                <option value="">All Categories</option>
                                                <option *ngFor="let category of categories" [value]="category.name">
                                                    {{category.name}}
                                                </option>
                                            </select>
                                            
                                            <select [(ngModel)]="assignmentDateFilter" (change)="filterUserReportAssignments()">
                                                <option value="">All Time</option>
                                                <option value="today">Today</option>
                                                <option value="week">This Week</option>
                                                <option value="month">This Month</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="table-container">
                                        <table class="assignments-table">
                                            <thead>
                                                <tr>
                                                    <th>User</th>
                                                    <th>Report</th>
                                                    <th>Category</th>
                                                    <th>Assigned Date</th>
                                                    <th>Assigned By</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr *ngFor="let assignment of filteredUserReportAssignments">
                                                    <td>
                                                        <div class="user-cell">
                                                            <div class="user-avatar-small">{{assignment.userName.charAt(0).toUpperCase()}}</div>
                                                            <span>{{assignment.userName}}</span>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="report-cell">
                                                            <i class="icon">üìÑ</i>
                                                            <span>{{assignment.reportFileName}}</span>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="category-badge">{{assignment.categoryName}}</span>
                                                    </td>
                                                    <td>{{assignment.assignedAt | date:'MMM d, y, h:mm a'}}</td>
                                                    <td>{{assignment.assignedBy}}</td>
                                                    <td>
                                                        <span class="status-badge" [class.active]="assignment.isActive">
                                                            {{assignment.isActive ? 'Active' : 'Inactive'}}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <div class="action-buttons">
                                                            <button class="btn btn-sm btn-secondary" 
                                                                    (click)="viewAssignmentDetails(assignment)"
                                                                    title="View Details">
                                                                <i class="icon">üëÅÔ∏è</i>
                                                            </button>
                                                            <button class="btn btn-sm btn-danger" 
                                                                    (click)="initiateRemoveAssignment(assignment.id)"
                                                                    title="Remove Assignment">
                                                                <i class="icon">üóëÔ∏è</i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="table-footer">
                                        <div class="results-info">
                                            Showing {{filteredUserReportAssignments.length}} of {{userReportAssignments.length}} assignments
                                        </div>
                                        <div class="pagination">
                                            <!-- Pagination can be added here if needed -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modals -->
<!-- Delete Category Modal -->
<app-confirmation-modal
  [isVisible]="showDeleteConfirmation"
  title="Delete Category"
  message="Are you sure you want to delete this category? This action cannot be undone."
  confirmText="Delete"
  cancelText="Cancel"
  (confirmed)="confirmDeleteCategory()"
  (cancelled)="cancelDeleteCategory()">
</app-confirmation-modal>

<!-- Delete Report Modal -->
<app-confirmation-modal
  [isVisible]="showDeleteReportConfirmation"
  title="Delete Report"
  message="Are you sure you want to delete this report? This action cannot be undone."
  confirmText="Delete"
  cancelText="Cancel"
  (confirmed)="confirmDeleteReport()"
  (cancelled)="cancelDeleteReport()">
</app-confirmation-modal>

<!-- Remove Assignment Modal -->
<app-confirmation-modal
  [isVisible]="showRemoveAssignmentConfirmation"
  title="Remove Assignment"
  message="Are you sure you want to remove this assignment? The user will no longer have access to this report."
  confirmText="Remove"
  cancelText="Cancel"
  (confirmed)="confirmRemoveAssignment()"
  (cancelled)="cancelRemoveAssignment()">
</app-confirmation-modal>

<!-- Toast Notifications -->
<app-toast></app-toast>