<!-- User Management Header -->
<div class="page-header">
  <div class="header-content">
    <h1 class="page-title">User Management</h1>
    <p class="page-subtitle">Manage users, roles, and permissions</p>
  </div>
  <button class="btn btn-primary" (click)="openAddUserModal()">
    <i class="icon-plus"></i>
    Add New User
  </button>
</div>

<!-- Tab Navigation -->
<div class="tab-navigation">
  <button 
    class="tab-btn" 
    [class.active]="activeTab === 'all'"
    (click)="onTabChange('all')">
    All Users ({{ users.length }})
  </button>
  <button 
    class="tab-btn" 
    [class.active]="activeTab === 'banned'"
    (click)="onTabChange('banned')">
    Banned Users ({{ bannedUsers.length }})
  </button>
</div>

<!-- Search Bar -->
<div class="search-container">
  <div class="search-box">
    <i class="icon-search"></i>
    <input 
      type="text" 
      placeholder="Search users by name, department, title, or role..."
      [(ngModel)]="searchTerm"
      class="search-input">
  </div>
</div>

<!-- Loading Spinner -->
<div *ngIf="loading" class="loading-container">
  <div class="spinner"></div>
  <p>Loading users...</p>
</div>

<!-- Users Table -->
<div *ngIf="!loading" class="table-container">
  <table class="users-table">
    <thead>
      <tr>
        <th>User</th>
        <th>Department</th>
        <th>Title</th>
        <th>Status</th>
        <th>Roles</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let user of filteredUsers; trackBy: trackByUserId" class="user-row">
        <td class="user-info">
          <div class="user-avatar">
            {{ getUserAvatarLetter(user) }}
          </div>
          <div class="user-details">
            <span class="username">{{ user.userName }}</span>
            <span class="user-id">ID: {{ user.id }}</span>
          </div>
        </td>
        <td>{{ user.departmentName || 'N/A' }}</td>
        <td>{{ user.title || 'N/A' }}</td>
        <td>
          <span class="status-badge" [ngClass]="getStatusClass(user)">
            {{ getStatusText(user) }}
          </span>
        </td>
        <td class="roles-cell">
          <div class="roles-container">
            <span *ngFor="let role of user.roles" class="role-tag">
              {{ role }}
            </span>
            <span *ngIf="user.roles.length === 0" class="no-roles">No roles assigned</span>
          </div>
        </td>
        <td class="actions-cell">
          <div class="action-buttons">
            <!-- Combined Edit Roles & Permissions Button -->
            <button 
              class="btn-action btn-edit" 
              (click)="openRolePermissionModal(user)"
              title="Edit Roles & Permissions">
              <i class="fas fa-edit"></i>
              Manage
            </button>
            
            <!-- User Profile Button -->
            <button 
              class="btn-action btn-profile" 
              [routerLink]="['/admin-management/users', user.id, 'profile']"
              title="View Profile">
              <i class="fas fa-user"></i>
              Profile
            </button>
            
            <!-- Ban/Unban Button -->
            <button 
              class="btn-action" 
              [class.btn-ban]="!user.isDisabled"
              [class.btn-unban]="user.isDisabled"
              (click)="showBanConfirmation(user)"
              [title]="user.isDisabled ? 'Unban User' : 'Ban User'">
              <i class="fas" [class.fa-ban]="!user.isDisabled" [class.fa-check]="user.isDisabled"></i>
              {{ user.isDisabled ? 'Unban' : 'Ban' }}
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
  
  <!-- Empty State -->
  <div *ngIf="filteredUsers.length === 0" class="empty-state">
    <div class="empty-icon">ðŸ‘¥</div>
    <h3>No users found</h3>
    <p *ngIf="searchTerm">Try adjusting your search criteria</p>
    <p *ngIf="!searchTerm && activeTab === 'all'">No users have been added yet</p>
    <p *ngIf="!searchTerm && activeTab === 'banned'">No banned users</p>
  </div>
</div>

<!-- Add User Modal -->
<!-- Add User Modal - Updated with consistent checkbox style -->
<div *ngIf="showAddUserModal" class="modal-overlay" (click)="closeAddUserModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Add New User</h2>
      <button class="close-btn" (click)="closeAddUserModal()">Ã—</button>
    </div>
    
    <form [formGroup]="addUserForm" (ngSubmit)="onSubmitAddUser()">
      <div class="form-group">
        <label for="userName">Username</label>
        <input 
          type="text" 
          id="userName"
          formControlName="userName"
          class="form-input"
          placeholder="Enter username">
        <div *ngIf="addUserForm.get('userName')?.invalid && addUserForm.get('userName')?.touched" 
             class="error-message">
          Username is required (minimum 3 characters)
        </div>
      </div>
      
      <div class="form-group">
        <label for="password">Password</label>
        <input 
          type="password" 
          id="password"
          formControlName="password"
          class="form-input"
          placeholder="Enter password">
        <div *ngIf="addUserForm.get('password')?.invalid && addUserForm.get('password')?.touched" 
             class="error-message">
          Password is required (minimum 6 characters)
        </div>
      </div>

      <div class="form-group">
        <label for="department">Department</label>
        <select 
          id="department"
          formControlName="department"
          class="form-control">
          <option value="">Select Department</option>
          <option *ngFor="let dept of departments" [value]="dept.name">{{ dept.name }}</option>
        </select>
        <div *ngIf="addUserForm.get('department')?.invalid && addUserForm.get('department')?.touched" 
             class="error-message">
          Department is required
        </div>
      </div>

      <div class="form-group">
        <label for="title">Title</label>
        <input 
          type="text" 
          id="title"
          formControlName="title"
          class="form-input"
          placeholder="Enter job title">
      </div>
      
      <!-- Updated Roles Section with card-style checkboxes -->
      <div class="form-section">
        <div class="section-header">
          <i class="fas fa-users"></i>
          <h3>Roles</h3>
          <p>Select roles to assign to this user</p>
        </div>
        
        <div class="checkbox-grid">
          <label *ngFor="let role of roles" class="checkbox-card">
            <input 
              type="checkbox" 
              [value]="role.name"
              [checked]="isRoleSelectedForNewUser(role.name)"
              (change)="onRoleCheckboxChange($event, role.name)">
            <div class="checkbox-content">
              <div class="checkbox-header">
                <span class="checkmark"></span>
                <strong>{{ role.name }}</strong>
              </div>
              <div class="checkbox-description">
                <span class="permission-count">{{ role.permissionCount || 0 }} permissions</span>
              </div>
            </div>
          </label>
        </div>
        
        <div *ngIf="addUserForm.get('roles')?.invalid && addUserForm.get('roles')?.touched" 
             class="error-message" style="margin-top: 1rem; padding-left: 0;">
          Please select at least one role
        </div>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeAddUserModal()">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="addUserForm.invalid || loading">
          <span *ngIf="loading" class="btn-spinner"></span>
          Add User
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Combined Role & Permission Management Modal -->
<div *ngIf="showRolePermissionModal" class="modal-overlay" (click)="closeRolePermissionModal()">
  <div class="modal-content large-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Manage Access - {{ selectedUser?.userName }}</h2>
      <button class="close-btn" (click)="closeRolePermissionModal()">Ã—</button>
    </div>
    
    <!-- Permission Summary -->
  <!--  <div *ngIf="selectedUserPermissions" class="permission-summary">
      <div class="summary-card">
        <div class="summary-item">
          <i class="fas fa-users summary-icon"></i>
          <div>
            <div class="summary-number">{{ selectedUserPermissions.roleBasedPermissions.length || 0 }}</div>
            <div class="summary-label">Role Permissions</div>
          </div>
        </div>
        <div class="summary-item">
          <i class="fas fa-key summary-icon"></i>
          <div>
            <div class="summary-number">{{ selectedUserPermissions.individualPermissions.length || 0 }}</div>
            <div class="summary-label">Individual Permissions</div>
          </div>
        </div>
        <div class="summary-item total">
          <i class="fas fa-shield-alt summary-icon"></i>
          <div>
            <div class="summary-number">{{ selectedUserPermissions.allPermissions.length || 0 }}</div>
            <div class="summary-label">Total Permissions</div>
          </div>
        </div>
      </div>
    </div>-->
    
    <form [formGroup]="rolePermissionForm" (ngSubmit)="onSubmitRolePermissions()">
      
      <!-- Roles Section -->
      <div class="form-section">
        <div class="section-header">
          <i class="fas fa-users"></i>
          <h3>Roles</h3>
          <p>Assign roles that grant sets of permissions</p>
        </div>
        
        <div class="checkbox-grid">
          <label *ngFor="let role of roles" class="checkbox-card">
            <input 
              type="checkbox" 
              [value]="role.id"
              [checked]="rolePermissionForm.value.roleIds?.includes(role.id)"
              (change)="onRoleIdCheckboxChange($event, role.id)">
            <div class="checkbox-content">
              <div class="checkbox-header">
                <span class="checkmark"></span>
                <strong>{{ role.name }}</strong>
              </div>
              <div class="checkbox-description">
                <span class="permission-count">{{ role.permissionCount || 0 }} permissions</span>
              </div>
            </div>
          </label>
        </div>
      </div>
      
      <!-- Individual Permissions Section -->
      <div class="form-section">
        <div class="section-header">
          <i class="fas fa-key"></i>
          <h3>Individual Permissions</h3>
          <p>Grant specific permissions independent of roles</p>
        </div>
        
        <div class="permissions-grid">
          <label *ngFor="let permission of availablePermissions" class="permission-card">
            <input 
              type="checkbox" 
              [value]="permission"
              [checked]="rolePermissionForm.value.individualPermissions?.includes(permission)"
              (change)="onIndividualPermissionCheckboxChange($event, permission)">
            <div class="permission-content">
              <span class="checkmark"></span>
              <div class="permission-info">
                <span class="permission-name">{{ permission }}</span>
                <div class="permission-badges">
                  <span *ngIf="isPermissionFromRole(permission)" class="badge badge-role">
                    <i class="fas fa-users"></i> From Role
                  </span>
                </div>
              </div>
            </div>
          </label>
        </div>
      </div>
      
      <!-- Current Role-Based Permissions (Read-Only) -->
     <!--<div *ngIf="selectedUserPermissions && selectedUserPermissions.roleBasedPermissions && selectedUserPermissions.roleBasedPermissions.length > 0" 
           class="form-section readonly-section">
        <div class="section-header">
          <i class="fas fa-lock"></i>
          <h3>Current Role-Based Permissions</h3>
          <p>These permissions come from assigned roles and cannot be modified here</p>
        </div>
        
        <div class="readonly-permissions">
          <div *ngFor="let permission of selectedUserPermissions.roleBasedPermissions" 
               class="readonly-permission">
            <i class="fas fa-shield-alt"></i>
            <span>{{ permission }}</span>
            <span class="badge badge-role">
              <i class="fas fa-users"></i> Role
            </span>
          </div>
        </div>
      </div>--> 
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeRolePermissionModal()">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="loading">
          <span *ngIf="loading" class="btn-spinner"></span>
          <i class="fas fa-save"></i>
          Update Access
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Confirmation Modal -->
<app-confirmation-modal
  [isVisible]="showConfirmation"
  [title]="confirmationTitle"
  [message]="confirmationMessage"
  [confirmText]="confirmButtonText"
  [cancelText]="'Cancel'"
  (confirmed)="onConfirmAction()"
  (cancelled)="onCancelAction()">
</app-confirmation-modal>